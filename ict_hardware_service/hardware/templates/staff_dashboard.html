{% extends "base.html" %}
{% load static %}

{% block title %}Staff Dashboard{% endblock %}

{% block content %}
<div class="grid two-col">
  <section class="card">
    <h3>Submit New Hardware Request</h3>
    <form method="post" action="{% url 'create_request' %}">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <label for="id_category">Hardware Type</label>
      {{ form.category }}

      <label for="id_description">Problem Description</label>
      {{ form.description }}

      <button type="submit" class="btn">Submit Request</button>
    </form>
  </section>

  <section class="card">
    <h3>My Requests</h3>
    <table id="requests-table" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Category</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requests %}
        <tr>
          <td>{{ req.id }}</td>
          <td>{{ req.category }}</td>
          <td><span class="status {{ req.status|slugify|lower }}">{{ req.status }}</span></td>
          <td>{{ req.date_requested|date:"d M Y H:i" }}</td>
          <td>
            <a href="{% url 'request_detail' req.id %}" class="btn btn-info btn-sm">View</a>
            <a href="{% url 'delete_staff_request' req.id %}" class="btn btn-danger btn-sm"
               onclick="return confirm('Are you sure you want to delete this request?');">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5">No requests yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- âœ… Auto-refresh every 10s -->
<script>
setInterval(() => {
  fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('#requests-table tbody');
      document.querySelector('#requests-table tbody').innerHTML = newBody.innerHTML;
    })
    .catch(err => console.error('Refresh error:', err));
}, 10000);
</script>
{% endblock %}
