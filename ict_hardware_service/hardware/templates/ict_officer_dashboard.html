{% extends "base.html" %}
{% load static %}

{% block title %}ICT Officer Dashboard{% endblock %}

{% block content %}
<section class="card">
  <div class="toolbar" style="display: flex; justify-content: space-between; align-items: center;">
    <h2>All Hardware Requests</h2>
    <a href="{% url 'ict_officer_job_history' %}" class="btn btn-ghost">View Job History</a>
  </div>

  <div class="toolbar">
    <a class="btn" href="?status=Pending">Pending</a>
    <a class="btn" href="?status=Assigned">Assigned</a>
    <a class="btn" href="?status=In Progress">In Progress</a>
    <a class="btn" href="?status=Completed">Completed</a>
  </div>

  <table id="requests-table" class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Staff</th>
        <th>Category</th>
        <th>Summary</th>
        <th>Status</th>
        <th>Assigned / Action</th>
      </tr>
    </thead>
    <tbody>
      {% for req in requests %}
      <tr>
        <td>{{ req.id }}</td>
        <td>{{ req.staff.get_full_name|default:req.staff.username }}</td>
        <td>{{ req.category }}</td>
        <td>{{ req.description|truncatechars:60 }}</td>
        <td><span class="status {{ req.status|slugify|lower }}">{{ req.status }}</span></td>
        <td>
          {% if req.status == "Pending" %}
            <a href="{% url 'assign_technician' req.id %}" class="btn btn-warning btn-sm">Assign</a>
            <a href="{% url 'delete_request' req.id %}" class="btn btn-danger btn-sm"
               onclick="return confirm('Are you sure you want to delete this request?');">Delete</a>
          {% else %}
            {% if req.assigned_to %}
              {{ req.assigned_to.user.get_full_name|default:req.assigned_to.user.username }}
            {% else %}
              <em>Not Assigned</em>
            {% endif %}
            <a href="{% url 'delete_request' req.id %}" class="btn btn-danger btn-sm"
               onclick="return confirm('Delete this request? This cannot be undone.');">Delete</a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7">No requests found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
setInterval(() => {
  fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('#requests-table tbody');
      document.querySelector('#requests-table tbody').innerHTML = newBody.innerHTML;
    })
    .catch(err => console.error('Refresh error:', err));
}, 10000);
</script>
{% endblock %}
